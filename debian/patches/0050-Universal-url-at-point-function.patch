From: "Igor B. Poretsky" <poretsky@mlbox.ru>
Date: Thu, 10 Nov 2022 17:56:19 +0300
Subject: Universal url-at-point function

---
 lisp/emacspeak-eww.el          |  6 +++---
 lisp/emacspeak-url-template.el |  4 +---
 lisp/emacspeak-webutils.el     | 26 ++++++++++++++++++++++++--
 3 files changed, 28 insertions(+), 8 deletions(-)

diff --git a/lisp/emacspeak-eww.el b/lisp/emacspeak-eww.el
index 4be4520..3408664 100644
--- a/lisp/emacspeak-eww.el
+++ b/lisp/emacspeak-eww.el
@@ -509,7 +509,7 @@ are available are cued by an auditory icon on the header line."
       emacspeak-webutils-document-title #'emacspeak-eww-current-title
       emacspeak-webutils-url-at-point
       #'(lambda ()
-          (let ((url (shr-url-at-point nil)))
+          (let ((url (emacspeak-webutils-url-at-point nil)))
             (cond
              ((and url
                    (stringp url)
@@ -2054,8 +2054,8 @@ interactive prefix arg `delete', delete that mark instead."
 Warning: Running shell script cbox through this fails mysteriously."
   (interactive "P")
   (cl-declare (special emacspeak-eww-url-shell-commands))
-  (cl-assert (shr-url-at-point prefix) t "No URL at point.")
-  (let ((url (shr-url-at-point prefix))
+  (cl-assert (emacspeak-webutils-url-at-point prefix) t "No URL at point.")
+  (let ((url (emacspeak-webutils-url-at-point prefix))
         (cmd (completing-read "Shell Command: " emacspeak-eww-url-shell-commands)))
     (shell-command (format "%s '%s'" cmd url))
     (emacspeak-auditory-icon 'task-done)))
diff --git a/lisp/emacspeak-url-template.el b/lisp/emacspeak-url-template.el
index 94a0e20..cb026fe 100644
--- a/lisp/emacspeak-url-template.el
+++ b/lisp/emacspeak-url-template.el
@@ -1559,7 +1559,6 @@ template."
 ;;}}}
 ;;{{{Reddit At Point:
 
-(declare-function shr-url-at-point "shr" (image-url))
 (declare-function emacspeak-google-canonicalize-result-url "emacspeak-google" (url))
 (declare-function emacspeak-google-result-url-prefix "emacspeak-google" nil)
 
@@ -1570,8 +1569,7 @@ template."
  #'(lambda (_url)
      (let* ((u
              (or
-              (shr-url-at-point nil)
-              (browse-url-url-at-point)
+              (emacspeak-webutils-url-at-point nil)
               (read-from-minibuffer "URL:")))
             (url
              (if (string-prefix-p (emacspeak-google-result-url-prefix) u)
diff --git a/lisp/emacspeak-webutils.el b/lisp/emacspeak-webutils.el
index 004466b..bac08d5 100644
--- a/lisp/emacspeak-webutils.el
+++ b/lisp/emacspeak-webutils.el
@@ -54,6 +54,14 @@
 (require 'url)
 (require 'browse-url)
 (require 'shr)
+(require 'w3m-util "w3m-util" 'noerror)
+
+;;}}}
+;;{{{ Forward declarations
+
+(declare-function shr-url-at-point "shr.el")
+(declare-function w3m-anchor "ext:w3m-util.el" (&optional position))
+(declare-function w3m-image "ext:w3m-util.el" (&optional position))
 
 ;;}}}
 ;;{{{ Utility: Render HTML To String
@@ -214,12 +222,26 @@ Forward punctuation and rate  settings to resulting buffer."
               (eq major-mode 'eww-mode))
     (error "This command cannot be used outside browser buffers.")))
 
+(defun emacspeak-webutils-url-at-point (image-url)
+  "Return the URL under point as a string.
+If IMAGE-URL is non-nil, or there is no link under point, but
+there is an image under point then copy the URL of the image
+under point instead."
+  (if (eq major-mode 'w3m-mode)
+      (if image-url
+          (w3m-image (point))
+        (w3m-anchor (point)))
+    (if (fboundp 'shr-url-at-point)
+        (shr-url-at-point image-url)
+      (unless image-url
+        (browse-url-url-at-point)))))
+
 (defalias 'emacspeak-webutils-read-url 'emacspeak-webutils-read-this-url)
 
 (defun emacspeak-webutils-read-this-url ()
   "Return URL under point
 or URL read from minibuffer."
-  (let ((url (shr-url-at-point nil)))
+  (let ((url (emacspeak-webutils-url-at-point nil)))
     (if url
         url 
       (car (browse-url-interactive-arg "URL: ")))))
@@ -309,7 +331,7 @@ and xsl environment specified by style, params and options."
   "Function variable returning the current document title.")
 
 (defvar emacspeak-webutils-url-at-point
-  #'(lambda nil (shr-url-at-point nil))
+  #'(lambda nil (emacspeak-webutils-url-at-point nil))
   "Function variable returning the value of the url under point
   in a Web page.")
 
