From: "Igor B. Poretsky" <poretsky@mlbox.ru>
Date: Thu, 10 Nov 2022 22:53:57 +0300
Subject: Diff support

---
 lisp/emacspeak-diff-mode.el | 67 +++++++++++++++++++++++++++++++++++++++++++++
 lisp/emacspeak.el           |  1 +
 2 files changed, 68 insertions(+)

diff --git a/lisp/emacspeak-diff-mode.el b/lisp/emacspeak-diff-mode.el
index d90f9b8..2b256ee 100644
--- a/lisp/emacspeak-diff-mode.el
+++ b/lisp/emacspeak-diff-mode.el
@@ -88,6 +88,73 @@
        (emacspeak-speak-line)))))
 
 ;;}}}
+;;{{{ advice  interactive commands
+
+(defadvice diff-goto-source (after emacspeak pre act comp)
+  "Provide spoken feedback."
+  (when (ems-interactive-p)
+    (emacspeak-auditory-icon 'open-object)
+    (emacspeak-speak-line)))
+
+(cl-loop for f in 
+      '(diff-hunk-next diff-hunk-prev)
+      do
+      (eval
+       `(defadvice ,f (after emacspeak pre act comp)
+          "Provide spoken feedback."
+          (when (ems-interactive-p)
+            (emacspeak-auditory-icon 'select-object)
+            (emacspeak-speak-line)))))
+
+(cl-loop for f in 
+      '(diff-file-next diff-file-prev)
+      do
+      (eval
+       `(defadvice ,f (after emacspeak pre act comp)
+          "Provide spoken feedback."
+          (when (ems-interactive-p)
+            (emacspeak-auditory-icon 'large-movement)
+            (emacspeak-speak-line)))))
+
+(cl-loop for f in 
+      '(diff-hunk-kill diff-file-kill)
+      do
+      (eval
+       `(defadvice ,f (after emacspeak pre act comp)
+          "Provide spoken feedback."
+          (when (ems-interactive-p)
+            (emacspeak-auditory-icon 'delete-object)
+            (emacspeak-speak-line)))))
+
+(cl-loop for f in 
+      '(diff-apply-hunk
+        diff-refine-hunk
+        diff-ignore-whitespace-hunk
+        diff-context->unified
+        diff-unified->context
+        diff-ediff-patch
+        diff-reverse-direction
+        diff-split-hunk
+        diff-test-hunk)
+      do
+      (eval
+       `(defadvice ,f (after emacspeak pre act comp)
+          "Provide spoken feedback."
+          (when (ems-interactive-p)
+            (emacspeak-auditory-icon 'task-done)))))
+
+;;}}}
+;;{{{ advise process filter and sentinels
+
+(defadvice diff-sentinel (after emacspeak pre act )
+  "Provide auditory feedback."
+  (emacspeak-auditory-icon 'task-done)
+  (message "process diff finished%s"
+           (if (equal 0 (ad-get-arg 0))
+               " with no differences"
+             "")))
+
+;;}}}
 (provide 'emacspeak-diff-mode)
 ;;{{{ end of file
 
diff --git a/lisp/emacspeak.el b/lisp/emacspeak.el
index 7c25995..8b5210d 100644
--- a/lisp/emacspeak.el
+++ b/lisp/emacspeak.el
@@ -185,6 +185,7 @@ that implements the speech-enabling extensions for `package' (a string)."
 (emacspeak-do-package-setup "cus-edit" 'emacspeak-custom)
 (emacspeak-do-package-setup "debian-bug" 'emacspeak-debian-bug )
 (emacspeak-do-package-setup "desktop" 'emacspeak-desktop)
+(emacspeak-do-package-setup "diff" 'emacspeak-diff-mode)
 (emacspeak-do-package-setup "diff-mode" 'emacspeak-diff-mode)
 (emacspeak-do-package-setup "dired" 'emacspeak-dired)
 (emacspeak-do-package-setup "dismal" 'emacspeak-dismal)
